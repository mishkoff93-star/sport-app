<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SportTracker</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary: #bb86fc;
            --secondary: #03dac6;
            --text: #ffffff;
            --text-sec: #b0b0b0;
            --danger: #cf6679;
            --nav-height: 60px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            padding-bottom: calc(var(--nav-height) + 20px);
        }
        header {
            padding: 20px;
            background: linear-gradient(180deg, rgba(30,30,30,1) 0%, rgba(18,18,18,0) 100%);
            position: sticky; top: 0; z-index: 10;
        }
        h1 { margin: 0; font-size: 24px; }
        .subtitle { color: var(--text-sec); font-size: 14px; }
        .view { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        input, select {
            width: 100%; padding: 12px; margin-bottom: 10px;
            background: #2c2c2c; border: 1px solid #333;
            border-radius: 8px; color: white; font-size: 16px;
        }
        button {
            width: 100%; padding: 14px;
            background-color: var(--primary); color: #000;
            border: none; border-radius: 8px;
            font-weight: bold; font-size: 16px;
            cursor: pointer; transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
        button.secondary { background-color: #333; color: white; }
        button.danger { background-color: var(--danger); color: white; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height); background-color: #1e1e1e;
            display: flex; justify-content: space-around;
            align-items: center; border-top: 1px solid #333; z-index: 100;
        }
        .nav-item {
            color: var(--text-sec); text-align: center;
            font-size: 10px; cursor: pointer; flex: 1;
        }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        .leader-row {
            display: flex; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #333;
        }
        .leader-rank { width: 30px; font-weight: bold; color: var(--secondary); }
        .leader-avatar { width: 40px; height: 40px; border-radius: 50%; margin: 0 10px; object-fit: cover; }
        .leader-info { flex: 1; }
        .leader-score { font-weight: bold; color: var(--primary); }
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 5px; margin-top: 10px;
        }
        .cal-day {
            aspect-ratio: 1; background: #2c2c2c;
            border-radius: 6px; display: flex;
            flex-direction: column; align-items: center;
            justify-content: center; font-size: 12px;
            position: relative; cursor: pointer;
        }
        .cal-day.today { border: 1px solid var(--primary); }
        .cal-day.planned { background-color: rgba(187, 134, 252, 0.2); }
        .cal-day.done { background-color: rgba(3, 218, 198, 0.3); }
        .cal-day.missed { background-color: rgba(207, 102, 121, 0.3); }
        .dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 2px; }
        .dot.plan { background: var(--primary); }
        .dot.done { background: var(--secondary); }
        .loader {
            border: 4px solid #333; border-top: 4px solid var(--primary);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .badge {
            display: inline-block; padding: 5px 10px;
            background: #333; border-radius: 15px;
            font-size: 12px; margin: 5px 5px 5px 0;
            border: 1px solid var(--secondary); color: var(--secondary);
        }
    </style>
</head>
<body>

    <header id="app-header" style="display:none;">
        <h1 id="user-greeting">–ü—Ä–∏–≤–µ—Ç!</h1>
        <div class="subtitle">–¢–≤–æ–π —Å—á–µ—Ç: <span id="user-score" style="color:var(--primary)">0</span> | –°–µ—Ä–∏—è: <span id="user-streak">0</span> –Ω–µ–¥.</div>
    </header>

    <div id="view-login" class="view active">
        <div class="card" style="margin-top: 50px; text-align: center;">
            <h2>–°–ø–æ—Ä—Ç –¢—Ä–µ–∫–µ—Ä</h2>
            <p>–ó–∞–ø–ª–∞–Ω–∏—Ä—É–π. –°–¥–µ–ª–∞–π. –ü–æ–ª—É—á–∏ –æ—á–∫–∏.</p>
            <input type="text" id="reg-name" placeholder="–ò–º—è –∏ –§–∞–º–∏–ª–∏—è">
            <button onclick="register()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="view-home" class="view">
        <div class="card">
            <h3>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
            <div id="achievements-list">
                <span class="badge">–ù–æ–≤–∏—á–æ–∫</span>
            </div>
        </div>
        <div class="card">
            <h3>üìÖ –ù–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
            <div id="today-status">–ü–ª–∞–Ω –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
            <button id="btn-do-today" class="secondary" style="margin-top:10px;" onclick="completeToday()">–Ø –±—ã–ª –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ!</button>
        </div>
    </div>

    <div id="view-calendar" class="view">
        <div class="card">
            <h3>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <select id="train-type">
                <option value="–ö–∞—Ä–¥–∏–æ">–ö–∞—Ä–¥–∏–æ (–ë–µ–≥/–í–µ–ª–æ—Å–∏–ø–µ–¥)</option>
                <option value="–°–∏–ª–æ–≤–∞—è">–°–∏–ª–æ–≤–∞—è (–ó–∞–ª)</option>
                <option value="–†–∞—Å—Ç—è–∂–∫–∞">–†–∞—Å—Ç—è–∂–∫–∞ / –ô–æ–≥–∞</option>
                <option value="–ò–≥—Ä–∞">–ò–≥—Ä–æ–≤–æ–π –≤–∏–¥ —Å–ø–æ—Ä—Ç–∞</option>
            </select>
            <input type="date" id="train-date">
            <button onclick="planTraining()">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div class="card">
            <h3>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h3>
            <div class="calendar-grid" id="calendar-grid"></div>
            <p style="font-size:12px; color:#666; margin-top:10px;">
                <span style="color:var(--primary)">‚ñ†</span> –ü–ª–∞–Ω &nbsp;
                <span style="color:var(--secondary)">‚ñ†</span> –í—ã–ø–æ–ª–Ω–µ–Ω–æ &nbsp;
                <span style="color:var(--danger)">‚ñ†</span> –ü—Ä–æ–ø—É—Å–∫
            </p>
        </div>
    </div>

    <div id="view-leaderboard" class="view">
        <div class="card">
            <h3>–¢–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
            <div id="leaderboard-list"><div class="loader"></div></div>
        </div>
    </div>

    <nav class="bottom-nav" id="app-nav" style="display:none;">
        <div class="nav-item active" onclick="switchView('home')">
            <span class="nav-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è
        </div>
        <div class="nav-item" onclick="switchView('calendar')">
            <span class="nav-icon">üìÖ</span>–ü–ª–∞–Ω
        </div>
        <div class="nav-item" onclick="switchView('leaderboard')">
            <span class="nav-icon">ü•á</span>–¢–æ–ø
        </div>
    </nav>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
        // ‚ö†Ô∏è –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–°–´–õ–ö–£ –ò–ó GOOGLE APPS SCRIPT (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –∫–æ–Ω—Ü–µ!)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVNEQTroHobIFpGzdg6ioymOXHMC-klPSXfW46MDu1SwKaSuev9A2p3bSBt7CsgA/exec';
        
        let currentUser = null;
        let allUsers = [];

        window.onload = function() {
            const savedUser = localStorage.getItem('sportUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
                loadLeaderboard();
                renderCalendar();
                checkTodayStatus();
            }
            document.getElementById('train-date').valueAsDate = new Date();
        };

        // === –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ===
        async function register() {
            const name = document.getElementById('reg-name').value.trim();
            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
            
            const btn = document.querySelector('#view-login button');
            btn.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            btn.disabled = true;
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Google Script (—Ä–µ–∂–∏–º no-cors –æ–±—Ö–æ–¥–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞)
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'register', name: name })
                });
                
                // –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ª–æ–∫–∞–ª—å–Ω–æ (—Ç–∞–∫ –∫–∞–∫ no-cors –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç)
                const id = 'user_' + Date.now();
                const avatar = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(name) + '&background=random';
                
                currentUser = { id, name, avatar, score: 0, streak: 0 };
                localStorage.setItem('sportUser', JSON.stringify(currentUser));
                
                showApp();
                loadLeaderboard();
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', e);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ —Å—Å—ã–ª–∫—É SCRIPT_URL.');
                btn.disabled = false;
                btn.innerText = '–í–æ–π—Ç–∏';
            }
        }

        function showApp() {
            document.getElementById('view-login').classList.remove('active');
            document.getElementById('view-home').classList.add('active');
            document.getElementById('app-header').style.display = 'block';
            document.getElementById('app-nav').style.display = 'flex';
            updateHeader();
        }

        function updateHeader() {
            if (!currentUser) return;
            const firstName = currentUser.name.split(' ')[0];
            document.getElementById('user-greeting').innerText = `–ü—Ä–∏–≤–µ—Ç, ${firstName}!`;
            document.getElementById('user-score').innerText = currentUser.score;
            document.getElementById('user-streak').innerText = currentUser.streak;
        }

        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navItems = document.querySelectorAll('.nav-item');
            if (viewName === 'home') navItems[0].classList.add('active');
            if (viewName === 'calendar') navItems[1].classList.add('active');
            if (viewName === 'leaderboard') navItems[2].classList.add('active');

            if (viewName === 'leaderboard') loadLeaderboard();
            if (viewName === 'calendar') renderCalendar();
        }

        // === –ó–ê–ì–†–£–ó–ö–ê –†–ï–ô–¢–ò–ù–ì–ê ===
        async function loadLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<div class="loader"></div>';
            
            try {
                const response = await fetch(SCRIPT_URL + '?action=getUsers');
                const data = await response.json();
                
                if (data.result !== 'success') {
                    list.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                    return;
                }
                
                allUsers = data.users;
                list.innerHTML = '';
                
                if (allUsers.length === 0) {
                    list.innerHTML = '<p style="color:#666">–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>';
                    return;
                }
                
                allUsers.forEach((u, index) => {
                    const isMe = u.id === currentUser?.id;
                    const html = `
                        <div class="leader-row" style="${isMe ? 'background:#2c2c2c; padding:10px; border-radius:8px;' : ''}">
                            <div class="leader-rank">${index + 1}</div>
                            <img src="${u.avatar}" class="leader-avatar" onerror="this.src='https://ui-avatars.com/api/?name=?'">
                            <div class="leader-info">
                                <div>${u.name} ${isMe ? '<small style="color:var(--secondary)">(–í—ã)</small>' : ''}</div>
                                <div style="font-size:12px; color:#888">–°–µ—Ä–∏—è: ${u.streak} –Ω–µ–¥.</div>
                            </div>
                            <div class="leader-score">${u.score}</div>
                        </div>
                    `;
                    list.innerHTML += html;
                });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:', e);
                list.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
        }

        // === –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï –¢–†–ï–ù–ò–†–û–í–ö–ò ===
        async function planTraining() {
            const type = document.getElementById('train-type').value;
            const date = document.getElementById('train-date').value;
            
            if (!date) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
            if (!currentUser) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = '...';
            btn.disabled = true;

            await sendLog('plan', `${type} –Ω–∞ ${date}`);
            
            alert('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞! +1 –æ—á–∫–æ');
            btn.innerText = originalText;
            btn.disabled = false;
            renderCalendar();
            refreshUserScore(1);
        }

        // === –û–¢–ú–ï–¢–ö–ê –û –í–´–ü–û–õ–ù–ï–ù–ò–ò ===
        async function completeToday() {
            if (!currentUser) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');
            
            const today = new Date().toISOString().split('T')[0];
            const btn = document.getElementById('btn-do-today');
            
            btn.disabled = true;
            btn.innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            await sendLog('complete', `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞ ${today}`);
            
            alert('üéâ –û—Ç–ª–∏—á–Ω–æ! +5 –æ—á–∫–æ–≤');
            btn.innerText = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ';
            refreshUserScore(5);
            checkTodayStatus();
        }

        // === –û–¢–ü–†–ê–í–ö–ê –õ–û–ì–ê ===
        async function sendLog(type, details) {
            if (!currentUser) return;
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'logAction',
                        user_id: currentUser.id,
                        type: type,
                        details: details
                    })
                });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞:', e);
            }
        }

        function refreshUserScore(points) {
            if (!currentUser) return;
            currentUser.score += points;
            localStorage.setItem('sportUser', JSON.stringify(currentUser));
            updateHeader();
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥, –µ—Å–ª–∏ –º—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–¢–æ–ø"
            if (document.getElementById('view-leaderboard').classList.contains('active')) {
                loadLeaderboard();
            }
        }

        // === –ö–ê–õ–ï–ù–î–ê–†–¨ ===
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'cal-day';
                
                if (i === today.getDate()) dayEl.classList.add('today');
                
                // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ª–æ–≥–∞–º)
                if (i < today.getDate() && Math.random() > 0.5) {
                    dayEl.classList.add('done');
                    dayEl.innerHTML = `${i}<div class="dot done"></div>`;
                } else if (i > today.getDate() && Math.random() > 0.7) {
                    dayEl.classList.add('planned');
                    dayEl.innerHTML = `${i}<div class="dot plan"></div>`;
                } else {
                    dayEl.innerText = i;
                }
                
                grid.appendChild(dayEl);
            }
        }

        function checkTodayStatus() {
            document.getElementById('today-status').innerText = "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞";
        }
    </script>
</body>
</html>
